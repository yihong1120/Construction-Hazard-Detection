üá¨üáß [English](./README.md) | üáπüáº [ÁπÅÈ´î‰∏≠Êñá](./README-zh-tw.md)

<img width="100%" src="./assets/images/project_graphics/banner.gif" alt="AI-Driven Construction Safety Banner">

<div align="center">
   <a href="examples/YOLO_server_api">Server-API</a> |
   <a href="examples/local_notification_server">FCM Notification Management Server</a>|
   <a href="examples/violation_records">Violation Records Server</a>|
   <a href="examples/db_management">Data Management Server</a>|
   <a href="examples/streaming_web">Streaming-Web</a> |
   <a href="examples/YOLO_data_augmentation">Data-Augmentation</a> |
   <a href="examples/YOLO_evaluation">Evaluation</a> |
   <a href="examples/YOLO_train">Train</a>
</div>

<br>

<div align="center">
   <!-- Row 1: Tools and Frameworks -->
   <a href="https://www.python.org/downloads/release/python-3127/">
      <img src="https://img.shields.io/badge/python-3.12.7-blue?logo=python" alt="Python 3.12.7">
   </a>
   <a href="https://github.com/ultralytics/ultralytics">
      <img src="https://img.shields.io/badge/YOLO11-ultralytics-blue?logo=yolo" alt="YOLO11">
   </a>
   <a href="https://scikit-learn.org/stable/modules/generated/sklearn.cluster.HDBSCAN.html">
      <img src="https://img.shields.io/badge/HDBSCAN-sklearn-orange?logo=scikit-learn" alt="HDBSCAN sklearn">
   </a>
   <a href="https://fastapi.tiangolo.com/">
      <img src="https://img.shields.io/badge/fastapi-0.115.5-blue?logo=fastapi" alt="FastAPI 0.115.5">
   </a>
   <a href="https://redis.io/">
      <img src="https://img.shields.io/badge/Redis-7.0.15-red?logo=redis" alt="Redis 7.0.15">
   </a>
   <a href="https://www.docker.com/">
      <img src="https://img.shields.io/badge/Docker-Container-blue?logo=docker" alt="Docker">
   </a>

   <!-- Row 2: Testing, code quality and data -->
   <a href="https://github.com/pre-commit/pre-commit">
      <img src="https://img.shields.io/badge/pre--commit-4.0.1-blue?logo=pre-commit" alt="Pre-commit 4.0.1">
   </a>
   <a href="https://docs.pytest.org/en/latest/">
      <img src="https://img.shields.io/badge/pytest-8.3.4-blue?logo=pytest" alt="pytest 8.3.4">
   </a>
   <a href="https://codecov.io/github/yihong1120/Construction-Hazard-Detection" >
      <img src="https://codecov.io/github/yihong1120/Construction-Hazard-Detection/graph/badge.svg?token=E0M66BUS8D" alt="Codecov">
   </a>
   <a href="https://codebeat.co/projects/github-com-yihong1120-construction-hazard-detection-main">
      <img alt="codebeat badge" src="https://codebeat.co/badges/383396a9-e2cb-4604-8990-c1707e5870cf" />
   </a>
   <a href="https://universe.roboflow.com/object-detection-qn97p/construction-hazard-detection">
      <img src="https://app.roboflow.com/images/download-dataset-badge.svg" alt="Download Dataset from Roboflow">
   </a>
   <a href="https://huggingface.co/yihong1120/Construction-Hazard-Detection-YOLO11">
      <img src="https://img.shields.io/badge/HuggingFace-Model%20Repo-yellow?logo=huggingface" alt="Hugging Face Model Repo">
   </a>
</div>

<br>

"Construction-Hazard-Detection" is an AI-powered tool designed to enhance safety on construction sites. By leveraging the YOLO model and self-developed algorithms for object detection, it identifies potential hazards such as:

- Workers without helmets
- Workers without safety vests
- Workers near machinery or vehicles
- Workers in restricted areas, restricted areas will be automatically generated by computing and clustering the coordinates of safety cones.
- Machineries or vehicles near utility poles

Post-processing algorithms further improve detection accuracy. The system is built for real-time deployment, offering instant analysis and alerts for identified hazards.

Additionally, the system integrates AI recognition results in real-time via a web interface. It can send notifications and real-time on-site images through messaging apps like LINE, Messenger, WeChat, and Telegram for prompt alerts and reminders. The system also supports multiple languages, enabling users to receive notifications and interact with the interface in their preferred language. Supported languages include:

- üáπüáº Traditional Chinese (Taiwan)
- üá®üá≥ Simplified Chinese (Mainland China)
- üá´üá∑ French
- üá¨üáß English
- üáπüá≠ Thai
- üáªüá≥ Vietnamese
- üáÆüá© Indonesian

This multi-language support makes the system accessible to a global audience, improving usability across different regions.

<br>
<br>

<div align="center">
   <img src="./assets/images/hazard-detection.png" alt="Hazard Detection Diagram" style="width: 100%;">
</div>

<br>

## Contents

- [Hazard Detection Examples](#hazard-detection-examples)
- [Usage](#usage)
- [Database Configuration and Management](#database-configuration-and-management)
- [Environment Variables](#environment-variables)
- [Additional Information](#additional-information)
- [Dataset Information](#dataset-information)
- [Contributing](#contributing)
- [Development Roadmap](#development-roadmap)
- [License](#license)

## Hazard Detection Examples

Below are examples of real-time hazard detection by the system:

<div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
  <!-- Example 1: Workers without Helmets or Safety Vests -->
  <div style="text-align: center; flex-basis: 33%;">
    <img src="./assets/images/demo/person_did_not_wear_safety_vest.png" alt="Workers without helmets or safety vests" style="width: 300px; height: 200px; object-fit: cover;">
    <p>Workers without Helmets or Safety Vests</p>
  </div>

  <!-- Example 2: Workers near Machinery or Vehicles -->
  <div style="text-align: center; flex-basis: 33%;">
    <img src="./assets/images/demo/person_near_machinery.jpg" alt="Workers near machinery or vehicles" style="width: 300px; height: 200px; object-fit: cover;">
    <p>Workers near Machinery or Vehicles</p>
  </div>

  <!-- Example 3: Workers in Restricted Areas -->
  <div style="text-align: center; flex-basis: 33%;">
    <img src="./assets/images/demo/persons_in_restricted_zones.jpg" alt="Workers in restricted areas" style="width: 300px; height: 200px; object-fit: cover;">
    <p>Workers in Restricted Areas</p>
  </div>
</div>


## Quick Start (Recommended)

Before running the application, complete the following quick start and environment variable setup steps. Preparing a JSON stream configuration file `config/configuration.json` is optional and generally not recommended; the default Database Mode centrally manages streams. If you need file-based multi-stream config for advanced use cases, see the optional example below.

```json
[
  {
    "video_url": "https://cctv1.kctmc.nat.gov.tw/6e559e58/",
    "site": "Kaohsiung",
    "stream_name": "Test",
    "model_key": "yolo11n",
    "notifications": {
      "line_token_1": "language_1",
      "line_token_2": "language_2"
    },
    "detect_with_server": true,
    "expire_date": "2024-12-31T23:59:59",
    "detection_items": {
      "detect_no_safety_vest_or_helmet": true,
      "detect_near_machinery_or_vehicle": true,
      "detect_in_restricted_area": true
    },
    "work_start_hour": 0,
    "work_end_hour": 24,
    "store_in_redis": true
  }
]
```

### ‚úÖ Startup Steps (Complete in Order)

1. **Install Docker (Required)**
   Please install [Docker Desktop / Docker Engine] on your computer first.

2. **Start Redis with Docker**

   ```bash
   docker run -d --name my-redis -p 6379:6379 \
   redis:latest redis-server --requirepass "password"
   ```

3. **Start MySQL with Docker (Windows / Linux)**

   ```bash
   docker run -d --name my-mysql -p 3306:3306 \
   -e MYSQL_ROOT_PASSWORD=ChangeMe! \
   -e MYSQL_DATABASE=construction_hazard_detection \
   -e MYSQL_USER=username \
   -e MYSQL_PASSWORD=password \
   mysql:latest \
   --default-authentication-plugin=mysql_native_password \
   --character-set-server=utf8mb4 \
   --collation-server=utf8mb4_unicode_ci
   ```

4. **Import Database Schema (First Time Only)**

* **Windows PowerShell / CMD:**

   ```bash
   type .\scripts\init.sql | docker exec -i my-mysql \
   mysql -u username -p"password" --default-character-set=utf8mb4 construction_hazard_detection
   ```

* **Linux / macOS:**

   ```bash
   cat ./scripts/init.sql | docker exec -i my-mysql \
   mysql -u username -p"password" --default-character-set=utf8mb4 construction_hazard_detection
   ```

5. **Install Required Python Packages:**

   ```bash
   pip install -r requirements.txt
   ```

6. **Download YOLO11 weights from Hugging Face (to models/pt):**

- CLI (places files under `./models/pt`):

   Hugging Face model repo: https://huggingface.co/yihong1120/Construction-Hazard-Detection-YOLO11

   ```bash
   hf download \
      yihong1120/Construction-Hazard-Detection-YOLO11 \
      --repo-type model \
      --include "models/pt/*.pt" \
      --local-dir .
   ```

- Python (same effect):

   ```python
   from huggingface_hub import snapshot_download

   snapshot_download(
       repo_id="yihong1120/Construction-Hazard-Detection-YOLO11",
       repo_type="model",
       local_dir=".",
       local_dir_use_symlinks=False,
       allow_patterns=["models/pt/*.pt"],
   )
   ```

7. **Start Each API (from project root, use separate terminals for each)**

* Data Management (DB Management)

   ```bash
   uvicorn examples.db_management.app:app --host 127.0.0.1 --port 8005 --workers 2
   ```

* Notification Server (FCM / Local Notification)

   ```bash
   uvicorn examples.local_notification_server.app:app --host 127.0.0.1 --port 8003 --workers 2
   ```

* Streaming Web Backend

   ```bash
   uvicorn examples.streaming_web.backend.app:app --host 127.0.0.1 --port 8800 --workers 2
   ```

* Violation Records API

   ```bash
   uvicorn examples.violation_records.app:app --host 127.0.0.1 --port 8002 --workers 2
   ```

* YOLO Detection API

   ```bash
   uvicorn examples.YOLO_server_api.backend.app:app --host 127.0.0.1 --port 8000 --workers 2
   ```

8. **Start the Main Program (Two Modes)**

Choose one mode only; do not run Database Mode and JSON Mode at the same time.

* **Database Mode (Default)**
  `main.py` will poll the `stream_configs` table and dynamically start/restart/stop stream subprocesses.

   ```bash
   python main.py
   # Optional: adjust polling interval (default 10 seconds)
   python main.py --poll 5
   ```

* **JSON Mode (File-based Multi-stream Config) ‚Äî Optional, advanced; not recommended for most users**
   Use `--config` to specify the JSON file path; the main program will start a subprocess for each stream config in the array. This mode is mutually exclusive with Database Mode.

   ```bash
   python main.py --config config/configuration.json
   ```

> To stop: Press `Ctrl + C` to gracefully terminate all subprocesses and release resources.
> `.env` will be loaded automatically at startup (`python-dotenv`).

9. **Frontend Page (Cloud Demo)**
   Open: [https://visionnaire-cda17.web.app](https://visionnaire-cda17.web.app)
   Login: `user` / `password`

> Before using, please open the Web Settings and configure API endpoints first (e.g., DETECT_API_URL, STREAMING_API_URL, DB_MANAGEMENT_API_URL, FCM_API_URL) to match your environment; then proceed with login and operations.

### iOS App

- App Store: https://apps.apple.com/tw/app/visionnaire/id6743549024

Note: For complete notification functionality, please contact us.


## Database Configuration and Management

The system uses MySQL to store stream, site, violation, and user data.
Database name: `construction_hazard_detection`

Main tables:

* `stream_configs`: Stream settings (URL, site, model, notifications, detection items, work hours, etc.)
* `sites`: Site information
* `users`: System users
* `violations`: Violation records

> See `scripts/init.sql` for full SQL schema. Please complete the "Import Database Schema" step above before first run.

## Environment Variables

Create a `.env` file in the project root as follows (adjust as needed):

```dotenv
# Database
DATABASE_URL='mysql+asyncmy://username:password@127.0.0.1/construction_hazard_detection'

# API Credentials
API_USERNAME='user'
API_PASSWORD='password'

# API URLs
DETECT_API_URL="http://127.0.0.1:8000"
FCM_API_URL="http://127.0.0.1:8003"
VIOLATION_RECORD_API_URL="http://127.0.0.1:8002"
STREAMING_API_URL="http://127.0.0.1:8800"
DB_MANAGEMENT_API_URL="http://127.0.0.1:8005"

# Redis
REDIS_HOST='127.0.0.1'
REDIS_PORT=6379
REDIS_PASSWORD='password'

# Firebase
FIREBASE_CRED_PATH='examples/local_notification_server/your-firebase-adminsdk.json'
project_id='your-project-id'

# (Optional) LINE / Cloudinary credentials, add if integrated:
# LINE_CHANNEL_ACCESS_TOKEN='YOUR_LINE_CHANNEL_ACCESS_TOKEN'
# CLOUDINARY_CLOUD_NAME='YOUR_CLOUDINARY_CLOUD_NAME'
# CLOUDINARY_API_KEY='YOUR_CLOUD_API_KEY'
# CLOUDINARY_API_SECRET='YOUR_CLOUD_API_SECRET'
```

> **Note**
>
> * If services are deployed on different hosts or containers, change `127.0.0.1` to the accessible address.
> * MySQL and Redis credentials must match your Docker environment variables (e.g., `MYSQL_USER`, `MYSQL_PASSWORD`, `--requirepass`).
> * Be sure to complete the `scripts/init.sql` import before first run.

## Additional Information

- The system logs are available within the Docker container and can be accessed for debugging purposes.
- The output images with detections (if enabled) will be saved to the specified output path.
- Notifications will be sent through LINE messaging API during the specified hours if hazards are detected.

### Notes

- Ensure that the `Dockerfile` is present in the root directory of the project and is properly configured as per your application's requirements.

For more information on Docker usage and commands, refer to the [Docker documentation](https://docs.docker.com/).

## Dataset Information

The primary dataset for training this model is the [Construction Site Safety Image Dataset from Roboflow](https://www.kaggle.com/datasets/snehilsanyal/construction-site-safety-image-dataset-roboflow/data). We have enriched this dataset with additional annotations and made it openly accessible on Roboflow. The enhanced dataset can be found here: [Construction Hazard Detection on Roboflow](https://universe.roboflow.com/side-projects/construction-hazard-detection). This dataset includes the following labels:

- `0: 'Hardhat'`
- `1: 'Mask'`
- `2: 'NO-Hardhat'`
- `3: 'NO-Mask'`
- `4: 'NO-Safety Vest'`
- `5: 'Person'`
- `6: 'Safety Cone'`
- `7: 'Safety Vest'`
- `8: 'Machinery'`
- `9: 'Utility Pole'`
- `10: 'Vehicle'`

### Models for detection

| Model   | size<br><sup>(pixels) | mAP<sup>val<br>50 | mAP<sup>val<br>50-95 | params<br><sup>(M) | FLOPs<br><sup>(B) |
| ------- | --------------------- | ------------------ | ------------------ | ----------------- | ----------------- |
| YOLO11n | 640                   | 58.0               | 34.2               | 2.6               | 6.5               |
| YOLO11s | 640                   | 70.1               | 44.8               | 9.4               | 21.6              |
| YOLO11m | 640                   | 73.3               | 42.6               | 20.1              | 68.0              |
| YOLO11l | 640                   | 77.3               | 54.6               | 25.3              | 86.9              |
| YOLO11x | 640                   | 82.0               | 61.7               | 56.9              | 194.9             |

<br>

Our comprehensive dataset ensures that the model is well-equipped to identify a wide range of potential hazards commonly found in construction environments.

## License

This project is licensed under the [AGPL-3.0 License](LICENSE.md).
