
ğŸ‡¬ğŸ‡§ [English](./README.md) | ğŸ‡¹ğŸ‡¼ [ç¹é«”ä¸­æ–‡](./README-zh-tw.md)

# å€åŸŸé€šçŸ¥ä¼ºæœå™¨ç¯„ä¾‹

æ­¤ç¯„ä¾‹ç¤ºç¯„å¦‚ä½•åœ¨ FastAPI å°ˆæ¡ˆä¸­æ•´åˆ Firebase Cloud Messagingï¼ˆFCMï¼‰ï¼Œä»¥å‘å®¢æˆ¶ç«¯è£ç½®ï¼ˆå¦‚ Androidã€iOSã€Webï¼‰å‚³é€æ¨æ’­é€šçŸ¥ã€‚å®ƒåŒ…å«ï¼š

- å¦‚ä½•åˆå§‹åŒ–ä¸¦ä½¿ç”¨ Firebase Admin SDK ä¾†ç™¼é€ FCM æ¶ˆæ¯ã€‚
- å¦‚ä½•åœ¨ Redis ä¸­å„²å­˜ã€ç®¡ç†è£ç½® Tokenï¼ˆå¯ä¾ä½¿ç”¨è€…æˆ–ç«™é»åˆ†çµ„ï¼‰ã€‚
- å¦‚ä½•è¨­è¨ˆ FastAPI çš„ç«¯é»ä»¥å„²å­˜ Tokenã€åˆªé™¤ Tokenã€ä»¥åŠç™¼é€é€šçŸ¥ã€‚
- å¦‚ä½•åœ¨ç™¼é€å‰ç¿»è­¯é€šçŸ¥è¨Šæ¯è‡³å¤šç¨®èªè¨€ï¼ˆç¯„ä¾‹ä¸­é€éç°¡æ˜“çš„å­—å…¸ç¿»è­¯æ©Ÿåˆ¶ï¼‰ã€‚

## ç›®éŒ„

1. [æ¦‚è¦½](#æ¦‚è¦½)
2. [å…ˆæ±ºæ¢ä»¶](#å…ˆæ±ºæ¢ä»¶)
3. [å»ºç«‹ Firebase å°ˆæ¡ˆ](#å»ºç«‹-firebase-å°ˆæ¡ˆ)
4. [ç”¢ç”Ÿæœå‹™å¸³è™Ÿæ†‘è­‰æª”](#ç”¢ç”Ÿæœå‹™å¸³è™Ÿæ†‘è­‰æª”)
5. [ç›®éŒ„çµæ§‹](#ç›®éŒ„çµæ§‹)
6. [å®‰è£](#å®‰è£)
7. [è¨­å®š](#è¨­å®š)
8. [åŸ·è¡Œç¯„ä¾‹](#åŸ·è¡Œç¯„ä¾‹)
9. [API ä½¿ç”¨èªªæ˜](#api-ä½¿ç”¨èªªæ˜)
10. [å…¶ä»–æ³¨æ„äº‹é …](#å…¶ä»–æ³¨æ„äº‹é …)

## æ¦‚è¦½

æ­¤å€åŸŸé€šçŸ¥ä¼ºæœå™¨ç”¨æ–¼æ¥æ”¶è«‹æ±‚ä¸¦é€é FCM å°‡æ¨æ’­é€šçŸ¥å‚³é€çµ¦å®¢æˆ¶ç«¯è£ç½®ã€‚ä¸»è¦åŠŸèƒ½ï¼š

1. åœ¨ Redis ä¸­å„²å­˜ FCM è£ç½® Tokenï¼ˆä»¥ä½¿ç”¨è€… ID ç‚ºéµï¼‰ã€‚
2. æ ¹æ“šè£ç½®çš„èªè¨€è¨­å®šï¼Œå°‡é•è¦ï¼è­¦å‘Šè¨Šæ¯ç¿»è­¯ç‚ºå°æ‡‰èªç³»å…§å®¹ã€‚
3. ä»¥èªè¨€åˆ†çµ„çš„æ–¹å¼æ‰¹æ¬¡ç™¼é€é€šçŸ¥ã€‚

ç•¶åµæ¸¬åˆ°é•è¦äº‹ä»¶ï¼ˆä¾‹å¦‚ã€Œæœªæˆ´å®‰å…¨å¸½ã€ã€Œéæ–¼é è¿‘æ©Ÿå…·ã€ç­‰ï¼‰ï¼Œä¼ºæœå™¨å¯æ¨é€è‡ªè¨‚åŒ–çš„é€šçŸ¥ï¼ŒåŒ…å«ç›¸é—œçš„æ–‡å­—å…§å®¹èˆ‡é¸æ“‡æ€§åœ–ç‰‡ã€‚

## å…ˆæ±ºæ¢ä»¶

1. **Redis**ï¼šæ­¤æ‡‰ç”¨ç¨‹å¼ä¾è³´åœ¨ Redis ä¸­å„²å­˜è£ç½® Tokenã€‚
2. **å·²æœ‰å¯é‹ä½œçš„ FastAPI æ‡‰ç”¨ç¨‹å¼**ï¼šè«‹åƒè€ƒæœ¬ç¯„ä¾‹å€‰åº«ä¸­çš„ `examples/auth` ç¤ºç¯„ï¼Œä»¥äº†è§£èº«åˆ†é©—è­‰ç­‰åŸºæœ¬çµæ§‹ã€‚
3. **Firebase å°ˆæ¡ˆ**ï¼šå¿…é ˆæ“æœ‰ä¸€å€‹å•Ÿç”¨äº† Cloud Messaging çš„ Firebase å°ˆæ¡ˆã€‚
4. **Python 3.9+**ï¼ˆå»ºè­°ï¼‰

## å»ºç«‹ Firebase å°ˆæ¡ˆ

1. å‰å¾€ [Firebase Console](https://console.firebase.google.com/)ã€‚
2. å»ºç«‹ä¸€å€‹æ–°å°ˆæ¡ˆï¼ˆæˆ–ä½¿ç”¨æ—¢æœ‰å°ˆæ¡ˆï¼‰ã€‚
3. å»ºç«‹å®Œæˆå¾Œï¼Œè‡³ **å°ˆæ¡ˆè¨­å®š** -> **ä¸€èˆ¬**ï¼Œç¢ºèªä½ çš„ **å°ˆæ¡ˆ ID**ï¼ˆä¾‹å¦‚ `construction-harzard-detection`ï¼‰ã€‚
4. åœ¨ **Cloud Messaging** å€åŸŸï¼Œç¢ºèªå·²å•Ÿç”¨ FCM åŠŸèƒ½ï¼ˆé è¨­å·²å•Ÿç”¨ï¼‰ã€‚

## ç”¢ç”Ÿæœå‹™å¸³è™Ÿæ†‘è­‰æª”

1. åœ¨ Firebase å°ˆæ¡ˆé é¢ï¼Œé€²å…¥ **å°ˆæ¡ˆè¨­å®š** -> **æœå‹™å¸³è™Ÿ**ã€‚
2. åœ¨ Firebase Admin SDK å€åŸŸä¸­æŒ‰ **ç”¢ç”Ÿæ–°çš„ç§å¯†é‡‘é‘°**ã€‚
   - ç³»çµ±æœƒä¸‹è¼‰ä¸€å€‹ `.json` æ†‘è­‰æª”ï¼Œå…§å«ç§é‘°ã€client email ç­‰è³‡è¨Šã€‚
3. **é‡æ–°å‘½å**æˆ–ä¿ç•™æ­¤ `.json` æª”æ¡ˆåç¨±ã€‚ç¯„ä¾‹ä¸­ä½¿ç”¨ï¼š
   ```
   construction-harzard-detection-firebase-adminsdk-fbsvc-ca9d30aff7.json
   ```
4. å°‡æ­¤æª”æ¡ˆæ”¾å…¥ `examples/local_notification_server/` è³‡æ–™å¤¾ï¼ˆæˆ–å…¶ä»–å®‰å…¨ä½ç½®ï¼‰ã€‚
   - åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œè«‹å‹¿å°‡æ­¤æª”æ¡ˆç½®æ–¼å…¬é–‹çš„ Git å€‰åº«ä¸­ï¼Œä¸¦å¦¥å–„ç®¡ç†ç§˜å¯†æ†‘è­‰ã€‚

## ç›®éŒ„çµæ§‹

ä»¥ä¸‹ç‚º `examples/local_notification_server` å…§çš„æª”æ¡ˆæ¦‚è¦½ï¼š

```
examples/local_notification_server/
â”œâ”€â”€ app.py
â”œâ”€â”€ fcm_service.py
â”œâ”€â”€ lang_config.py
â”œâ”€â”€ routers.py
â”œâ”€â”€ schemas.py
â”œâ”€â”€ construction-harzard-detection-firebase-adminsdk-fbsvc-ca9d30aff7.json  (ä½ çš„ Firebase æ†‘è­‰æª”)
â””â”€â”€ README-zh-tw.md                    <- ä½ æ­£åœ¨é–±è®€çš„æª”æ¡ˆ
```

- **`app.py`**
  ç‚ºä¸»è¦çš„ FastAPI æ‡‰ç”¨ç¨‹å¼æª”æ¡ˆï¼Œä½¿ç”¨çˆ¶å±¤ï¼ˆ`examples/auth`ï¼‰çš„ `global_lifespan`ï¼Œä¸¦æ›è¼‰é€šçŸ¥ç›¸é—œçš„è·¯ç”±ã€‚

- **`fcm_service.py`**
  è² è²¬é€é Firebase Admin SDK ç™¼é€æ¨æ’­æ¶ˆæ¯ï¼Œè™•ç†æ‰¹æ¬¡ç™¼é€èˆ‡éŒ¯èª¤è¨˜éŒ„ã€‚

- **`lang_config.py`**
  å…§å«å¤šç¨®èªè¨€çš„ç¿»è­¯å­—å…¸ï¼Œä»¥åŠç°¡æ˜“çš„ `Translator` é¡åˆ¥ï¼Œç”¨æ–¼å°‡é•è¦è¨Šæ¯å°æ‡‰è‡³æ­£ç¢ºèªç³»ã€‚

- **`routers.py`**
  æä¾› FastAPI è·¯ç”±ä»¥ç®¡ç† Tokenï¼ˆ`/store_token`, `/delete_token`ï¼‰åŠç™¼é€é€šçŸ¥ï¼ˆ`/send_fcm_notification`ï¼‰ã€‚

- **`schemas.py`**
  å®šç¾© Pydantic æ¨¡å‹ï¼Œç”¨æ–¼è«‹æ±‚è³‡æ–™çš„é©—è­‰ï¼ˆä¾‹å¦‚ `TokenRequest`, `SiteNotifyRequest`ï¼‰ã€‚

- **`construction-harzard-detection-firebase-adminsdk-fbsvc-ca9d30aff7.json`**
  ç¯„ä¾‹ä¸­çš„ Firebase æœå‹™å¸³è™Ÿ JSON æª”ï¼ˆå¯¦å‹™ä¸Šè«‹ä½¿ç”¨ä½ è‡ªå·±çš„æª”æ¡ˆåç¨±å’Œè·¯å¾‘ï¼‰ã€‚

## å®‰è£

1. **è¤‡è£½æ­¤ç¯„ä¾‹ç¨‹å¼ç¢¼**ï¼ˆæˆ–å°‡ `examples/local_notification_server` è³‡æ–™å¤¾æ”¾é€²ä½ çš„å°ˆæ¡ˆï¼‰ã€‚
2. **å»ºç«‹ä¸¦å•Ÿç”¨è™›æ“¬ç’°å¢ƒ**ï¼ˆå¯é¸ä½†å»ºè­°ï¼‰ï¼š
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # macOS/Linux
   venv\Scripts\activate     # Windows
   ```
3. **å®‰è£å¥—ä»¶ä¾è³´**ï¼ˆåœ¨çˆ¶å±¤ `examples/auth` ä¹‹é¤˜ï¼Œé‚„éœ€è¦æ­¤ç¯„ä¾‹çš„éœ€æ±‚ï¼‰ï¼š
   ```bash
   pip install -r requirements.txt
   ```
   ï¼ˆæˆ–æ‰‹å‹•å®‰è£ `firebase-admin` ç­‰å¿…è¦å¥—ä»¶ï¼Œå¦‚æœç’°å¢ƒä¸­å°šæœªå®‰è£ã€‚ï¼‰

## è¨­å®š

1. **Firebase æ†‘è­‰æª”è·¯å¾‘**
   è«‹ç¢ºä¿ `fcm_service.py`ï¼ˆæˆ–åˆå§‹åŒ– Firebase çš„åœ°æ–¹ï¼‰æ‰€ä½¿ç”¨çš„è·¯å¾‘èˆ‡ `.json` æª”æ¡ˆåç¨±ä¸€è‡´ï¼Œä¾‹å¦‚ï¼š
   ```python
   cred_path = (
       "examples/local_notification_server/"
       "construction-harzard-detection-firebase-adminsdk-fbsvc-ca9d30aff7.json"
   )
   ```
   è‹¥ä½ æ›´æ”¹æª”åæˆ–è·¯å¾‘ï¼Œéœ€åŒæ­¥åœ¨ç¨‹å¼ä¸­æ›´æ–°ã€‚

2. **Redis**
   æ­¤ç¯„ä¾‹ä¾è³´çˆ¶å±¤ `examples/auth` ä¸­çš„ Redis æ¨¡çµ„ï¼ˆ`redis_pool.py` ç­‰ï¼‰ã€‚è«‹åœ¨ `.env` æˆ–ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®šå¥½ `REDIS_HOST`, `REDIS_PORT`, ä»¥åŠï¼ˆè‹¥éœ€è¦ï¼‰`REDIS_PASSWORD`ã€‚

3. **è³‡æ–™åº«**
   åŒæ¨£åœ°ï¼Œè«‹åœ¨ `.env` ä¸­è¨­å®š SQLAlchemy è³‡æ–™åº«é€£ç·šå­—ä¸²ï¼Œå› ç‚ºæŸäº›ç«¯é»ï¼ˆä¾‹å¦‚å„²å­˜ Token æ™‚ï¼‰æœƒæŸ¥è©¢ä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨ã€‚

## åŸ·è¡Œç¯„ä¾‹

ä»¥ä¸‹æŒ‡ä»¤å¯ç”¨ä¾†åŸ·è¡Œæ­¤æœ¬åœ°é€šçŸ¥ä¼ºæœå™¨ï¼ˆä¾ç…§ `app.py` ç¯„ä¾‹ï¼‰ï¼š

```bash
python examples/local_notification_server/app.py
```

è‹¥ä½ çš„å°ˆæ¡ˆåœ¨æ ¹ç›®éŒ„æœ‰ä¸€å€‹ `main.py` å°ˆé–€åŒ¯å…¥ä¸¦åŸ·è¡Œæ­¤æ¨¡çµ„ï¼Œè«‹ä¾å¯¦éš›æƒ…æ³èª¿æ•´ã€‚é è¨­æœƒç›£è½ `127.0.0.1:8003`ã€‚

å¯ä½¿ç”¨ [HTTPie](https://httpie.io/) æˆ– cURL æ¸¬è©¦å…¶åŠŸèƒ½ã€‚

## API ä½¿ç”¨èªªæ˜

ä¸»è¦è·¯ç”±å®šç¾©æ–¼ `routers.py`ï¼š

### 1. å„²å­˜ FCM Token
```
POST /store_token
```
**Body**ï¼ˆ`TokenRequest`ï¼‰ï¼š
```json
{
  "user_id": 1,
  "device_token": "AAAA-VVVV-1234-XYZ",
  "device_lang": "en-GB"
}
```
- æœƒåœ¨ Redis çš„ `fcm_tokens:{user_id}` å“ˆå¸Œè¡¨ä¸­ï¼Œå¯«å…¥ä»¥ device token ç‚ºæ¬„ä½ã€èªè¨€ç¢¼ç‚ºå€¼çš„è¨˜éŒ„ã€‚

### 2. åˆªé™¤ FCM Token
```
DELETE /delete_token
```
**Body**ï¼ˆ`TokenRequest`ï¼‰ï¼š
```json
{
  "user_id": 1,
  "device_token": "AAAA-VVVV-1234-XYZ"
}
```
- æœƒåœ¨å°æ‡‰ä½¿ç”¨è€…çš„ Redis å“ˆå¸Œè¡¨ä¸­ï¼Œåˆªé™¤è©² Token æ¬„ä½ã€‚

### 3. ç™¼é€ FCM é€šçŸ¥
```
POST /send_fcm_notification
```
**Body**ï¼ˆ`SiteNotifyRequest`ï¼‰ï¼š
```json
{
  "site": "siteA",
  "stream_name": "Camera-01",
  "body": {
    "warning_no_hardhat": {"count": 2},
    "warning_close_to_machinery": {"count": 1}
  },
  "image_path": "https://example.com/image.jpg",
  "violation_id": 123
}
```
- å¾è³‡æ–™åº«ä¸­æŸ¥è©¢å°æ‡‰ç«™é»ï¼Œå–å¾—å…¶é—œè¯ä½¿ç”¨è€…ï¼Œä¸¦åœ¨ Redis ä¸­æ”¶é›†æ‰€æœ‰ Tokenã€‚
- ä¾èªè¨€åˆ†çµ„ Tokenï¼Œä½¿ç”¨ `Translator.translate_from_dict()` ç¿»è­¯å‘Šè­¦è¨Šæ¯ã€‚
- é‡å°ä¸åŒèªè¨€åˆ†åˆ¥å‘¼å« FCM Service ç™¼é€æ¨æ’­é€šçŸ¥ï¼ˆå¯åŒ…å«æ–‡å­—ã€åœ–ç‰‡ã€violation_id ç­‰é™„åŠ è³‡è¨Šï¼‰ã€‚
- å›å‚³ JSONï¼ŒæŒ‡ç¤ºæ˜¯å¦ç™¼é€æˆåŠŸã€‚

## å…¶ä»–æ³¨æ„äº‹é …

1. **è£ç½® Token**
   - Android å®¢æˆ¶ç«¯å¯é€é Firebase SDK å–å¾— FCM Tokenã€‚
   - iOS ç«¯éœ€å…ˆå•Ÿç”¨æ¨æ’­åŠŸèƒ½ï¼Œä¸¦å¾ APNs å–å¾— Tokenï¼Œå†ç”± Firebase SDK è½‰æ›æˆ FCM Tokenã€‚

2. **å®‰å…¨æ€§**
   - åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œå»ºè­°å°ç›¸é—œç«¯é»ï¼ˆä¾‹å¦‚ `/store_token`ï¼‰é€²è¡Œä¿è­·ã€‚æ­¤ç¯„ä¾‹ä¾è³´çˆ¶å±¤çš„ JWT é©—è­‰ï¼ˆé€é `jwt_access`ï¼‰ä¾†ä¿è­· `/send_fcm_notification`ã€‚
   - å¯è€ƒæ…®å¢åŠ é€Ÿç‡é™åˆ¶æˆ–ç”¨æˆ¶èº«ä»½æª¢æŸ¥ï¼Œä»¥é˜²æ­¢æ¿«ç”¨ã€‚

3. **å¤šç§Ÿæˆ¶æˆ–ä¾ç«™é»**
   - æ­¤ç¯„ä¾‹é€éã€Œç«™é»ã€ç¶å®šä½¿ç”¨è€…åšåˆ†çµ„ã€‚è‹¥æœ‰å…¶ä»–éœ€æ±‚ï¼ˆå¦‚æ ¹æ“šè§’è‰²æˆ–ç‰¹å®šä½¿ç”¨è€…ç¾¤çµ„ï¼‰å¯è‡ªè¡Œèª¿æ•´é‚è¼¯ã€‚

4. **ç¿»è­¯ï¼ˆi18nï¼‰**
   - `lang_config.py` ä¸­åƒ…ä½¿ç”¨å­—å…¸é€²è¡Œç°¡å–®ç¿»è­¯ã€‚è‹¥éœ€æ›´å¤§è¦æ¨¡çš„å¤šèªç³»æ”¯æ´ï¼Œå¯è€ƒæ…®ä½¿ç”¨æ›´å°ˆæ¥­çš„ i18n å‡½å¼åº«æˆ–ç¿»è­¯ç®¡ç†ç³»çµ±ï¼ˆå¦‚ `gettext`ã€Transifexã€Crowdin ç­‰ï¼‰ã€‚

5. **æ—¥èªŒèˆ‡éŒ¯èª¤è™•ç†**
   - `fcm_service.py` è‹¥ç™¼é€å¤±æ•—ï¼Œæœƒé€é `logging.error` è¨˜éŒ„éŒ¯èª¤ã€‚åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œå»ºè­°å¯¦ä½œæ›´å®Œå–„çš„éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶ã€‚
